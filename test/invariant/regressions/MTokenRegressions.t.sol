// SPDX-FileCopyrightText: © 2024 Prototech Labs <info@prototechlabs.dev>
// SPDX-License-Identifier: AGPL-3.0-or-later
//
// Copyright © 2024 Christopher Mooney
// Copyright © 2024 Chris Smith
// Copyright © 2024 Brian McMichael
// Copyright © 2024 Derek Flossman
//
// This program is free software: you can redistribute it and/or modify
// it under the terms of the GNU Affero General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
// You should have received a copy of the GNU Affero General Public License
// along with this program.  If not, see <https://www.gnu.org/licenses/>.
pragma solidity ^0.8.23;

import { MTokenInvariants } from "../MTokenInvariants.t.sol";
// solhint-disable-next-line no-console, no-global-import
import "forge-std/console.sol";

contract MTokenRegressionTests is MTokenInvariants {
    function setUp() public override {
        super.setUp();
    }

    function _setMaxLeap(uint256 maxLeap) internal {
        _mTokenHandler.setMaxLeap(maxLeap);
    }

    // TODO: once Finding 8.1 is resolved, re-enable this test to ensure the invariant is working
    // function test_regression_invariant_M_B2_B3_B4_d1d15304_failure() external {
    //     _setMaxLeap(43200);
    //     _mTokenHandler.mint(63353733290953239360908134180967171684, 1822344376649243943, 115792089237316195423570985008687907853269984665640564039457584007913129639933);

    //     invariant_M_B2_B3_B4();
    // }



    // =========== Further Exploration Required ===========

    // function test_regression_invariant_M_B2_B3_B4_da6d4845_failure() external {
    //     _setMaxLeap(200000);
    //     _mTokenHandler.mint(115792089237316195423570985008687907853269984665640564039457584007913129639935, 452247059504320551675974, 46667416485406766757911130859955596839284290204802730212);
    //     _mTokenHandler.allowEarningOnBehalf(115792089237316195423570985008687907853269984665640564039457584007913129639934);
    //     _mTokenHandler.startEarning(373652006262320467999595998008604310570066778511835158316780844561);
    //     _mTokenHandler.startEarning(764549955);
    //     _mTokenHandler.mint(23605339856914304328848201318149084194632226948617038, 2, 599038166544913752810534203563046714);
    //     _mTokenHandler.updateIsEarnersListIgnored(8, true);
    //     _mTokenHandler.startEarningOnBehalfOf(3866627391537203399435265920853722409652251837836601569281283658, 115792089237316195423570985008687907853269984665640564039457584007913129639934);
    //     _mTokenHandler.mint(2, 26087760733375464616778398666076159213579546586049957456620983487020, 31074428715259089129761320986565626547332596902834918);

    //     invariant_M_B2_B3_B4();
    // }

    // function test_regression_invariant_M_B2_B3_B4_b8462236_failure() external {
    //     _setMaxLeap(200000);
    //     _mTokenHandler.updateIsEarnersListIgnored(115792089237316195423570985008687907853269984665640564039457584007913129639933, true);
    //     _mTokenHandler.startEarning(1322);
    //     _mTokenHandler.mint(115792089237316195423570985008687907853269984665640564039457584007913129639934, 319223391147983177612721736064420985887644979120440362735279297979, 115792089237316195423570985008687907853269984665640564039457584007913129639934);
    //     _mTokenHandler.startEarning(4968821038007916838901351145008266316643283127184099257668839502498378);
    //     _mTokenHandler.startEarning(15793244);
    //     _mTokenHandler.mint(78517167103814719436873156054713463222818932359426984083260, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 115792089237316195423570985008687907853269984665640564039457584007913129639932);
    //     _mTokenHandler.mint(220368847, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 115792089237316195423570985008687907853269984665640564039457584007913129639932);

    //     invariant_M_B2_B3_B4();
    // }

    // function test_regression_invariant_M_B2_B3_B4_bc05665d_failure() external {
    //     _setMaxLeap(200000);
    //     _mTokenHandler.approve(4735, 196865, 27020502126871186281680295503780039255774807856615338576534450657750299223612);
    //     _mTokenHandler.mint(3, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 115792089237316195423570985008687907853269984665640564039457584007913129639934);
    //     _mTokenHandler.updateIsEarnersListIgnored(18446744073709479002, true);
    //     _mTokenHandler.startEarning(73471348132037465186676393389869);
    //     _mTokenHandler.mint(4431914140782419944044491717332193772489787004242686532081902035, 63142830188540883120336683563465149827, 115792089237316195423570985008687907853269984665640564039457584007913129639933);
    //     _mTokenHandler.startEarning(9968);
    //     _mTokenHandler.mint(1743344158744109694565720221638813290769557, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 115792089237316195423570985008687907853269984665640564039457584007913129639932);

    //     invariant_M_B2_B3_B4();
    // }

    function test_regression_invariant_M_B1_94298119_failure() external {
        _setMaxLeap(3600);
        _mTokenHandler.permit(1532291727, 140566, 13549, 18194, 114332191156634837962569466132321615539172479032643914300051486532615039167019, 8774);
        _mTokenHandler.permitWithSignature(115792089237316195423570985008687907853269984665640564039457584007913129639934, 954234830253939427970380617225976466042581970593478596653534182684134777, 17768709018297241158958380927900508727352245877252167296, 2, 232402425462470933895711883331062636566757968512390687084, 308691272748262597052434123510760747088203145188939249820875029174);
        _mTokenHandler.receiveWithAuthorizationWithVS(13277, 5192296858534827628530496329220095, 13928, 18471, 1533, 8928, 14264);
        _mTokenHandler.startEarning(115792089237316195423570985008687907853269984665640564039457584007913129639934);
        _mTokenHandler.receiveWithAuthorizationWithSignature(4488, 10637, 466, 93491055732643446162585007533047270361900715250524909076278824216637049322755, 24096627821686890399448082645879675128714581396089814980851326060185502382150, 1814, 96560257906823366609687653797478744522194140651868327126155761560509877273244);
        _mTokenHandler.mint(3, 87028117636927008756675659894068061678998399485078851, 115792089237316195423570985008687907853269984665640564039457584007913129639935);
        _mTokenHandler.receiveWithAuthorizationWithSignature(115792089237316195423570985008687907853269984665640564039457584007913129639934, 6756745092765958540069863171405682, 259352206521646612464689, 42745633454749067536737, 2, 0, 5451243016444520246414039939300457207);
        _mTokenHandler.updateIsEarnersListIgnored(10098088198867272968413405375077851406398, true);
        _mTokenHandler.cancelAuthorizationWithSignature(115792089237316195423570985008687907853269984665640564039457584007913129639933, 0, 3);
        _mTokenHandler.startEarning(18446744073709452474);
        _mTokenHandler.startEarning(2);
        _mTokenHandler.transferWithAuthorization(32286390987242607095859845798964769856011434105686536717845489528247383228416, 15575321, 476, 4233, 17252, 2754, 1152);
        _mTokenHandler.startEarning(15582851);
        _mTokenHandler.transfer(115792089237316195423570985008687907853269984665640564039457584007913129639935, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 2);
        _mTokenHandler.updateEarnerRateModel(79, 1663562394);
        _mTokenHandler.updateIsEarnersListIgnored(0, false);
        _mTokenHandler.transfer(5358053057100692048, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 5763840486325714254247038901486384610594089);
        _mTokenHandler.cancelAuthorization(115792089237316195423570985008687907853269984665640564039457584007913129639934, 662378644691281373980601718132946383337, 606195562508463850783483168900840776772888209264203430137984141841364);
        _mTokenHandler.updateIndex(14491);
        _mTokenHandler.updateIsEarnersListIgnored(15578767, true);
        _mTokenHandler.updateEarnerRateModel(15596797, 426077503);
        _mTokenHandler.startEarning(757767419859794480304841775675849298442);
        _mTokenHandler.updateIndex(115792089237316195423570985008687907853269984665640564039457584007913129639935);
        _mTokenHandler.allowEarningOnBehalf(43112140675504265105754254905254);
        _mTokenHandler.transferFrom(15543625, 30049578511147215784808879450479838661460850480686708919063675984579152314368, 7718446825100741597347500652, 25240674983933929444626343895536606401697429333552526);
        _mTokenHandler.receiveWithAuthorizationWithSignature(368660093024803573722493830085894216698664800314, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 5219805150888897961517035577669938736082670806291201532, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 2, 1040869780151549547810969383754061, 6590254755612693117516779147699947731670635845947436916759);
        _mTokenHandler.startEarning(20860202094602311476394953488404);
        _mTokenHandler.cancelAuthorizationWithVS(3102, 94140245561101211052158450049065686161380952398180056015917333420614356336114, 575);
        _mTokenHandler.startEarning(0);
        _mTokenHandler.startEarning(2783);
        _mTokenHandler.permit(995218790, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 104924986050538956436873855662497837259945416390212179520684369870298, 75410219028608146732, 369050294130254413075205909538880004697556631731613828282405589466800283, 80467672780162451543376310338368243398863296781770101226);
        _mTokenHandler.updateIndex(1);
        _mTokenHandler.transfer(18446744073709479657, 30049578511147215784808879450479838400191783313190999688710071637055463489536, 136299);
        _mTokenHandler.startEarning(247755947);
        _mTokenHandler.updateIndex(115792089237316195423570985008687907853269984665640564039457584007913129639935);
        _mTokenHandler.transferWithAuthorization(80946961910497436199558034603810490764509150267896860983320655905420857961744, 18446744073708045121, 79628039206776296866320730453091258376608059038848424983855640263237377923728, 8562, 15567335, 1664219861, 83035527208013988248475708609372757846479995216655888220362641990976384603740);
        _mTokenHandler.startEarningOnBehalfOf(15467419081092867367322947028906604735798714423947961542, 5053396972597394495321705074116551);
        _mTokenHandler.stopEarning(3);
        _mTokenHandler.mint(18446744073709429083, 18446744073708065240, 29588276576228236);
        _mTokenHandler.startEarning(3);
        _mTokenHandler.updateIsEarnersListIgnored(15543471, false);
        _mTokenHandler.updateIsEarnersListIgnored(5416259454895437033045824018719168729752937968436304543802776088775138756, false);

        invariant_M_B1();
    }

    function test_regression_invariant_M_B2_B3_B4_5b816f48_failure() external {
        _setMaxLeap(3600);
        _mTokenHandler.disapproveEarner(2, 136762106085733882791343913573751906502221164392529452857787375119908);
        _mTokenHandler.updateIsEarnersListIgnored(11552978306589632914944452125794390169368047425694659, true);
        _mTokenHandler.startEarning(2533474936756140088541914283041616927213561231011499296610075091960642);
        _mTokenHandler.mint(768522906397982747021024539370271074129546448699736176352989, 0, 115792089237316195423570985008687907853269984665640564039457584007913129639935);
        _mTokenHandler.mint(9901, 5818880835048456587607217271013788, 44230173248058896243873321832119391);
        _mTokenHandler.startEarning(3127442583423743264897972444989);
        _mTokenHandler.startEarning(2);
        _mTokenHandler.mint(133428057033916056130457464510748017968557896923383315849662508667430, 131228011015374028084566754834394916127, 115792089237316195423570985008687907853269984665640564039457584007913129639934);

        invariant_M_B2_B3_B4();
    }

    function test_regression_invariant_M_B2_B3_B4_b58fa8ae_failure() external {
        _setMaxLeap(3600);
        _mTokenHandler.permitWithSignature(115792089237316195423570985008687907853269984665640564039457584007913129639933, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 1, 204059818418220793602021494766681501563656517031521922, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 13154430405720);
        _mTokenHandler.updateIsEarnersListIgnored(1162, true);
        _mTokenHandler.startEarning(1);
        _mTokenHandler.startEarning(393112518657485016537165935970505163087205710628);
        _mTokenHandler.mint(14069694605010663736220, 15587625, 31027003538573007141696453330577807267986812837979926391995879765166828232479);
        _mTokenHandler.startEarning(115792089237316195423570985008687907853269984665640564039457584007913129639933);
        _mTokenHandler.mint(10513086552287159337944413, 105737357039112771895115967668499629565118820869855133076091557983564247, 115792089237316195423570985008687907853269984665640564039457584007913129639934);
        _mTokenHandler.mint(30232538907538360452981685850851, 20687369968007355867894479, 669846329895485696335966010419580586656);

        invariant_M_B2_B3_B4();
    }

    function test_regression_invariant_M_B2_B3_B4_d51fc47f_failure() external {
        _setMaxLeap(3600);
        _mTokenHandler.updateIsEarnersListIgnored(1917986257248, true);
        _mTokenHandler.mint(2, 3, 115792089237316195423570985008687907853269984665640564039457584007913129639932);
        _mTokenHandler.startEarning(5801);
        _mTokenHandler.mint(115792089237316195423570985008687907853269984665640564039457584007913129639934, 1, 115792089237316195423570985008687907853269984665640564039457584007913129639934);
        _mTokenHandler.startEarning(1469000352);
        _mTokenHandler.mint(2, 3, 843263661329976296065149581945265326398307909510015760413489418858240792);

        invariant_M_B2_B3_B4();
    }

    function test_regression_invariant_M_B2_B3_B4_2f17d776_failure() external {
        _setMaxLeap(3600);
        _mTokenHandler.disallowEarningOnBehalf(115792089237316195423570985008687907853269984665640564039457584007913129639932);
        _mTokenHandler.startEarning(312);
        _mTokenHandler.mint(3, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 1848016260554553478715339213441757);
        _mTokenHandler.mint(2, 0, 760065559200624855379975626901946);
        _mTokenHandler.updateIsEarnersListIgnored(114675, true);
        _mTokenHandler.startEarning(115792089237316195423570985008687907853269984665640564039457584007913129639934);
        _mTokenHandler.startEarning(3);
        _mTokenHandler.mint(15827726259678513382573167461334290363280845942900477461836258123914642337884, 16971, 1461501637330902918203684832716283019655932542974);

        invariant_M_B2_B3_B4();
    }

    function test_regression_invariant_M_B2_B3_B4_71be3d72_failure() external {
        _setMaxLeap(3600);
        _mTokenHandler.transferWithAuthorization(1158, 502, 3220, 7616, 8418, 5670, 1076);
        _mTokenHandler.mint(3601392904586686175090328296366908381442117885003511733, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 115792089237316195423570985008687907853269984665640564039457584007913129639935);
        _mTokenHandler.mint(1, 9261454985957451366418729986282999793452685729768067172285954956, 29248700079827420849261957554029558529737033413824101623129009089276560241151);
        _mTokenHandler.startEarning(208696871835616853476682130226176720351544996529187771108732636);
        _mTokenHandler.transferWithAuthorizationWithSignature(2, 1645187121120, 114574308840076440694587514550399727194955749516103, 479587856608505490862443079010089865738808833, 1094366, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 0);
        _mTokenHandler.approveEarner(115792089237316195423570985008687907853269984665640564039457584007913129639934, 115792089237316195423570985008687907853269984665640564039457584007913129639934);
        _mTokenHandler.startEarning(2224069341478002390335586934899677);
        _mTokenHandler.transfer(69631334396179897151147, 616706070216538311896561350729255660779042627581911702, 146556536296660016258651863525405560935788276889906493041826588);
        _mTokenHandler.mint(48367, 30049578511147215784808879450479994855150655594492700169568982455369429155840, 75448592159843966673562083824292564727409298119785532238795147723735706894335);

        invariant_M_B2_B3_B4();
    }
}
